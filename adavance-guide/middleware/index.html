
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://tbice123123.github.io/langchain-dev-utils/adavance-guide/middleware/">
      
      
        <link rel="prev" href="../multi-agent/">
      
      
        <link rel="next" href="../pipeline/">
      
      
        
          <link rel="alternate" href="./" hreflang="en">
        
          <link rel="alternate" href="../../zh/adavance-guide/middleware/" hreflang="zh">
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.0">
    
    
      
        <title>Middleware - Langchain Dev Utils</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.618322db.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#middleware" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Langchain Dev Utils" class="md-header__button md-logo" aria-label="Langchain Dev Utils" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Langchain Dev Utils
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Middleware
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换到深色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换到深色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="切换到浅色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换到浅色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
      <div class="md-header__option">
  <div class="md-select">
    
    <button class="md-header__button md-icon" aria-label="Select language">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12.87 15.07-2.54-2.51.03-.03A17.5 17.5 0 0 0 14.07 6H17V4h-7V2H8v2H1v2h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2zm-2.62 7 1.62-4.33L19.12 17z"/></svg>
    </button>
    <div class="md-select__inner">
      <ul class="md-select__list">
        
          <li class="md-select__item">
            <a href="./" hreflang="en" class="md-select__link">
              English
            </a>
          </li>
        
          <li class="md-select__item">
            <a href="../../zh/adavance-guide/middleware/" hreflang="zh" class="md-select__link">
              中文
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</div>
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/tbice123123/langchain-dev-utils" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tbice123123/langchain-dev-utils
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Overview

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../getting-started-guide/installation/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../openai-compatible/" class="md-tabs__link">
          
  
  
  Advanced Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../api-reference/agent/" class="md-tabs__link">
          
  
  
  API Reference

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../example-project/" class="md-tabs__link">
        
  
  
    
  
  Usage Examples

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Langchain Dev Utils" class="md-nav__button md-logo" aria-label="Langchain Dev Utils" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Langchain Dev Utils
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/tbice123123/langchain-dev-utils" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    tbice123123/langchain-dev-utils
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started-guide/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started-guide/chat/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chat Model Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started-guide/embedding/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Embedding Model Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started-guide/format/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Formatting Sequences
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started-guide/message/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Message Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../getting-started-guide/tool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tool Calling Processing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Advanced Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Advanced Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../openai-compatible/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    OpenAI Compatible API Integration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../multi-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Agent Construction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Middleware
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Middleware
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-planning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Planning
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task Planning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tool-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tool Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comparison-with-official-to-do-list-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comparison with Official To-do List Middleware
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-routing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Model Routing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Model Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter Description">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model_list-configuration-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        model_list Configuration Description
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-define-the-model-list" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Define the Model List
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-create-agent-and-enable-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Create Agent and Enable Middleware
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent-handoffs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent Handoffs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Agent Handoffs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter Description">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agents_config-configuration-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        agents_config Configuration Description
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tool-call-repair" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tool Call Repair
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tool Call Repair">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formatting-system-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Formatting System Prompts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Formatting System Prompts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-variables-only-from-state" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Variables Only from state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-variables-from-both-state-and-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Variables from Both state and context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variable-override-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Variable Override Example
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    State-Graph Orchestration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../human-in-the-loop/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Add Human-in-the-Loop Support
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    API Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    API Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Agent Development Module API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/chat_model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chat Model Management Module API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/embeddings/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Embedding Model Management Module API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/message_convert/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Message Handling Module API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/tool_calling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Tool Calling Handling Module API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../api-reference/pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    State-Graph Orchestration Module API Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../example-project/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Usage Examples
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#task-planning" class="md-nav__link">
    <span class="md-ellipsis">
      
        Task Planning
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Task Planning">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#tool-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tool Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#comparison-with-official-to-do-list-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Comparison with Official To-do List Middleware
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-routing" class="md-nav__link">
    <span class="md-ellipsis">
      
        Model Routing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Model Routing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter Description">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#model_list-configuration-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        model_list Configuration Description
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#step-1-define-the-model-list" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 1: Define the Model List
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#step-2-create-agent-and-enable-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Step 2: Create Agent and Enable Middleware
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#agent-handoffs" class="md-nav__link">
    <span class="md-ellipsis">
      
        Agent Handoffs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Agent Handoffs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Parameter Description">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agents_config-configuration-description" class="md-nav__link">
    <span class="md-ellipsis">
      
        agents_config Configuration Description
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tool-call-repair" class="md-nav__link">
    <span class="md-ellipsis">
      
        Tool Call Repair
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Tool Call Repair">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#formatting-system-prompts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Formatting System Prompts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Formatting System Prompts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#parameter-description_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        Parameter Description
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usage-example_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        Usage Example
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Usage Example">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#getting-variables-only-from-state" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Variables Only from state
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-variables-from-both-state-and-context" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Variables from Both state and context
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#variable-override-example" class="md-nav__link">
    <span class="md-ellipsis">
      
        Variable Override Example
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="middleware">Middleware</h1>
<h2 id="overview">Overview</h2>
<p>Middleware is a component specifically built for LangChain's pre-built Agents. The official library provides some built-in middleware, and this library offers more practical middleware based on actual usage scenarios.</p>
<p>The middleware provided by this library includes:</p>
<ul>
<li><code>PlanMiddleware</code>: Task planning that breaks down complex tasks into ordered subtasks</li>
<li><code>ModelRouterMiddleware</code>: Dynamically routes to the most suitable model based on input content</li>
<li><code>HandoffAgentMiddleware</code>: Flexibly switches between multiple sub-agents</li>
<li><code>ToolCallRepairMiddleware</code>: Automatically fixes invalid tool calls from large models</li>
<li><code>format_prompt</code>: Dynamically formats placeholders in system prompts</li>
</ul>
<p>Additionally, this library extends the functionality of official middleware, supporting model specification through string parameters:</p>
<ul>
<li>SummarizationMiddleware</li>
<li>LLMToolSelectorMiddleware</li>
<li>ModelFallbackMiddleware</li>
<li>LLMToolEmulator</li>
</ul>
<h2 id="task-planning">Task Planning</h2>
<p><code>PlanMiddleware</code> is a middleware for structured decomposition and process management before executing complex tasks.</p>
<div class="admonition info">
<p class="admonition-title">Additional Information</p>
<p>Task planning is an efficient context engineering management strategy. Before executing a task, the large model first breaks down the overall task into multiple ordered subtasks, forming a task planning list (called a "plan" in this library). It then executes each subtask in sequence and dynamically updates the task status after completing each step until all subtasks are finished.</p>
</div>
<h3 id="parameter-description">Parameter Description</h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>system_prompt</code></td>
<td>System prompt. If <code>None</code>, the default prompt is used.<br><br><strong>Type</strong>: <code>str</code><br><strong>Required</strong>: No</td>
</tr>
<tr>
<td><code>custom_plan_tool_descriptions</code></td>
<td>Custom descriptions for plan-related tools.<br><br><strong>Type</strong>: <code>dict</code><br><strong>Required</strong>: No</td>
</tr>
<tr>
<td><code>use_read_plan_tool</code></td>
<td>Whether to enable the read plan tool.<br><br><strong>Type</strong>: <code>bool</code><br><strong>Required</strong>: No<br><strong>Default</strong>: <code>True</code></td>
</tr>
</tbody>
</table>
<p>The keys in the <code>custom_plan_tool_descriptions</code> dictionary can take the following three values:</p>
<table>
<thead>
<tr>
<th>Key</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>write_plan</code></td>
<td>Description of the write plan tool</td>
</tr>
<tr>
<td><code>finish_sub_plan</code></td>
<td>Description of the finish subplan tool</td>
</tr>
<tr>
<td><code>read_plan</code></td>
<td>Description of the read plan tool</td>
</tr>
</tbody>
</table>
<h3 id="usage-example">Usage Example</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">PlanMiddleware</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span>
        <span class="n">PlanMiddleware</span><span class="p">(</span>
            <span class="n">custom_plan_tool_descriptions</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;write_plan&quot;</span><span class="p">:</span> <span class="s2">&quot;Used for writing plans, breaking tasks into multiple ordered subtasks.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;finish_sub_plan&quot;</span><span class="p">:</span> <span class="s2">&quot;Used for completing subtasks, updating subtask status to completed.&quot;</span><span class="p">,</span>
                <span class="s2">&quot;read_plan&quot;</span><span class="p">:</span> <span class="s2">&quot;Used for querying the current task planning list.&quot;</span>
            <span class="p">},</span>
            <span class="n">use_read_plan_tool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># If not using the read plan tool, set this parameter to False</span>
        <span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;I want to visit New York for a few days, help me plan my itinerary&quot;</span><span class="p">)]}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>
<h3 id="tool-description">Tool Description</h3>
<p><code>PlanMiddleware</code> requires the use of two tools: <code>write_plan</code> and <code>finish_sub_plan</code>, while the <code>read_plan</code> tool is enabled by default; if not needed, the <code>use_read_plan_tool</code> parameter can be set to <code>False</code>.</p>
<h3 id="comparison-with-official-to-do-list-middleware">Comparison with Official To-do List Middleware</h3>
<p>This middleware has a similar functional positioning to LangChain's official <strong>To-do list middleware</strong>, but there are differences in tool design:</p>
<table>
<thead>
<tr>
<th>Feature</th>
<th>Official To-do List Middleware</th>
<th>This Library's PlanMiddleware</th>
</tr>
</thead>
<tbody>
<tr>
<td>Number of Tools</td>
<td>1 (<code>write_todo</code>)</td>
<td>3 (<code>write_plan</code>, <code>finish_sub_plan</code>, <code>read_plan</code>)</td>
</tr>
<tr>
<td>Functional Positioning</td>
<td>Focused on to-do lists</td>
<td>Specifically for planning lists</td>
</tr>
<tr>
<td>Operation Method</td>
<td>Adding and modifying done through one tool</td>
<td>Writing, modifying, and querying done through different tools</td>
</tr>
</tbody>
</table>
<p>Whether it's <code>todo</code> or <code>plan</code>, they are essentially the same concept. The key difference between this middleware and the official one is that it provides three specialized tools:</p>
<ul>
<li><code>write_plan</code>: Used for writing or updating plan content</li>
<li><code>finish_sub_plan</code>: Used to update the status after completing a subtask</li>
<li><code>read_plan</code>: Used for querying plan content</li>
</ul>
<h2 id="model-routing">Model Routing</h2>
<p><code>ModelRouterMiddleware</code> is a middleware for <strong>dynamically routing to the most suitable model based on input content</strong>. It analyzes user requests through a "routing model" and selects the most appropriate model from a predefined list to handle the current task.</p>
<h3 id="parameter-description_1">Parameter Description</h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>router_model</code></td>
<td>Model used for routing decisions.<br><br><strong>Type</strong>: <code>str</code> | <code>BaseChatModel</code><br><strong>Required</strong>: Yes</td>
</tr>
<tr>
<td><code>model_list</code></td>
<td>List of model configurations.<br><br><strong>Type</strong>: <code>list[ModelDict]</code><br><strong>Required</strong>: Yes</td>
</tr>
<tr>
<td><code>router_prompt</code></td>
<td>Custom prompt for the routing model.<br><br><strong>Type</strong>: <code>str</code><br><strong>Required</strong>: No</td>
</tr>
</tbody>
</table>
<h4 id="model_list-configuration-description"><code>model_list</code> Configuration Description</h4>
<p>Each model configuration is a dictionary containing the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>model_name</code></td>
<td>Unique identifier for the model, using <code>provider:model-name</code> format.<br><br><strong>Type</strong>: <code>str</code><br><strong>Required</strong>: Yes</td>
</tr>
<tr>
<td><code>model_description</code></td>
<td>Brief description of the model's capabilities or applicable scenarios.<br><br><strong>Type</strong>: <code>str</code><br><strong>Required</strong>: Yes</td>
</tr>
<tr>
<td><code>tools</code></td>
<td>Whitelist of tools that this model can call.<br><br><strong>Type</strong>: <code>list[BaseTool]</code><br><strong>Required</strong>: No</td>
</tr>
<tr>
<td><code>model_kwargs</code></td>
<td>Additional parameters when loading the model.<br><br><strong>Type</strong>: <code>dict</code><br><strong>Required</strong>: No</td>
</tr>
<tr>
<td><code>model_system_prompt</code></td>
<td>System-level prompt for the model.<br><br><strong>Type</strong>: <code>str</code><br><strong>Required</strong>: No</td>
</tr>
<tr>
<td><code>model_instance</code></td>
<td>Instantiated model object.<br><br><strong>Type</strong>: <code>BaseChatModel</code><br><strong>Required</strong>: No</td>
</tr>
</tbody>
</table>
<div class="admonition tip">
<p class="admonition-title">model_instance Field Description</p>
<ul>
<li><strong>If provided</strong>: Directly uses this instance, <code>model_name</code> is only for identification, <code>model_kwargs</code> is ignored; suitable for cases not using this library's conversation model management functionality.</li>
<li><strong>If not provided</strong>: Loads the model using <code>load_chat_model</code> based on <code>model_name</code> and <code>model_kwargs</code>.</li>
<li><strong>Naming format</strong>: In either case, it's recommended to use the <code>provider:model-name</code> format for <code>model_name</code>.</li>
</ul>
</div>
<h3 id="usage-example_1">Usage Example</h3>
<h4 id="step-1-define-the-model-list">Step 1: Define the Model List</h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware.model_router</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelDict</span>

<span class="n">model_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">ModelDict</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;vllm:qwen3-8b&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_description&quot;</span><span class="p">:</span> <span class="s2">&quot;Suitable for ordinary tasks, such as dialogue, text generation, etc.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">0.7</span><span class="p">,</span>
            <span class="s2">&quot;extra_body&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;chat_template_kwargs&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;enable_thinking&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">}},</span>
        <span class="p">},</span>
        <span class="s2">&quot;model_system_prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;You are an assistant, good at handling ordinary tasks, such as dialogue, text generation, etc.&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;vllm:qwen3-vl-2b&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_description&quot;</span><span class="p">:</span> <span class="s2">&quot;Suitable for visual tasks&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[],</span>  <span class="c1"># If this model doesn&#39;t need any tools, set this field to an empty list []</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;vllm:qwen3-coder-flash&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_description&quot;</span><span class="p">:</span> <span class="s2">&quot;Suitable for code generation tasks&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">run_python_code</span><span class="p">],</span>  <span class="c1"># Only allow the use of run_python_code tool</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="s2">&quot;openai:gpt-4o&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_description&quot;</span><span class="p">:</span> <span class="s2">&quot;Suitable for comprehensive high-difficulty tasks&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_system_prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;You are an assistant, good at handling comprehensive high-difficulty tasks&quot;</span><span class="p">,</span>
        <span class="s2">&quot;model_instance&quot;</span><span class="p">:</span> <span class="n">ChatOpenAI</span><span class="p">(</span>
            <span class="n">model_name</span><span class="o">=</span><span class="s2">&quot;gpt-4o&quot;</span>
        <span class="p">),</span>  <span class="c1"># Directly pass the instance, where model_name is only for identification, model_kwargs is ignored</span>
    <span class="p">},</span>
<span class="p">]</span>
</code></pre></div>
<h4 id="step-2-create-agent-and-enable-middleware">Step 2: Create Agent and Enable Middleware</h4>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelRouterMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">HumanMessage</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>  <span class="c1"># This model is only a placeholder, actually dynamically replaced by middleware</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">run_python_code</span><span class="p">,</span> <span class="n">get_current_time</span><span class="p">],</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ModelRouterMiddleware</span><span class="p">(</span>
            <span class="n">router_model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
            <span class="n">model_list</span><span class="o">=</span><span class="n">model_list</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span>

<span class="c1"># The routing middleware will automatically select the most suitable model based on input content</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;Help me write a bubble sort code&quot;</span><span class="p">)]})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>
<p>Through <code>ModelRouterMiddleware</code>, you can easily build a multi-model, multi-capability Agent that automatically selects the optimal model based on task type, improving response quality and efficiency.</p>
<h2 id="agent-handoffs">Agent Handoffs</h2>
<p><code>HandoffAgentMiddleware</code> is a middleware used for <strong>flexibly switching between multiple sub-agents</strong>, fully implementing LangChain's official <code>handoffs</code> multi-agent collaboration scheme.</p>
<h3 id="parameter-description_2">Parameter Description</h3>
<table>
<thead>
<tr>
<th>Parameter</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>agents_config</code></td>
<td>A dictionary of agent configurations, where the key is the agent name and the value is the agent configuration dictionary.<br><br><strong>Type</strong>: <code>dict[str, AgentConfig]</code><br><strong>Required</strong>: Yes</td>
</tr>
<tr>
<td><code>custom_handoffs_tool_descriptions</code></td>
<td>Custom descriptions for handoff tools, where the key is the agent name and the value is the corresponding handoff tool description.<br><br><strong>Type</strong>: <code>dict[str, str]</code><br><strong>Required</strong>: No</td>
</tr>
<tr>
<td><code>handoffs_tool_overrides</code></td>
<td>Custom implementations of handoff tools, where the key is the agent name and the value is the corresponding handoff tool implementation.<br><br><strong>Type</strong>: <code>dict[str, BaseTool]</code><br><strong>Required</strong>: No</td>
</tr>
</tbody>
</table>
<h4 id="agents_config-configuration-description"><code>agents_config</code> Configuration Description</h4>
<p>Each agent is configured as a dictionary containing the following fields:</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>model</code></td>
<td>Specifies the model used by this agent; if not passed, it inherits the model corresponding to the <code>model</code> parameter of <code>create_agent</code>. Supports strings (must be in <code>provider:model-name</code> format, e.g., <code>vllm:qwen3-4b</code>) or a <code>BaseChatModel</code> instance.<br><br><strong>Type</strong>: <code>str</code> | <code>BaseChatModel</code><br><strong>Required</strong>: No</td>
</tr>
<tr>
<td><code>prompt</code></td>
<td>The system prompt for the agent.<br><br><strong>Type</strong>: <code>str</code> | <code>SystemMessage</code><br><strong>Required</strong>: Yes</td>
</tr>
<tr>
<td><code>tools</code></td>
<td>A list of tools that the agent can call.<br><br><strong>Type</strong>: <code>list[BaseTool]</code><br><strong>Required</strong>: No</td>
</tr>
<tr>
<td><code>default</code></td>
<td>Whether to set as the default agent; defaults to <code>False</code>. There must be exactly one agent set to <code>True</code> in the entire configuration.<br><br><strong>Type</strong>: <code>bool</code><br><strong>Required</strong>: No</td>
</tr>
<tr>
<td><code>handoffs</code></td>
<td>A list of other agent names that this agent can hand off to. If set to <code>"all"</code>, it means this agent can hand off to all other agents.<br><br><strong>Type</strong>: <code>list[str]</code> | <code>str</code><br><strong>Required</strong>: Yes</td>
</tr>
</tbody>
</table>
<p>For this paradigm of multi-agent implementation, a tool used for handoffs is often required. This middleware utilizes the <code>handoffs</code> configuration of each agent to automatically create the corresponding handoff tool for each agent. If you wish to customize the description of the handoff tool, you can achieve this via the <code>custom_handoffs_tool_descriptions</code> parameter.</p>
<p><strong>Usage Example</strong></p>
<p>In this example, we will use four agents: <code>time_agent</code>, <code>weather_agent</code>, <code>code_agent</code>, and <code>default_agent</code>.</p>
<p>Next, we need to create the corresponding agent configuration dictionary <code>agent_config</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware.handoffs</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentConfig</span>

<span class="n">agent_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">AgentConfig</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;time_agent&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;vllm:qwen3-8b&quot;</span><span class="p">,</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a time assistant&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">get_current_time</span><span class="p">],</span>
        <span class="s2">&quot;handoffs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;default_agent&quot;</span><span class="p">],</span>  <span class="c1"># This agent can only hand off to default_agent</span>
    <span class="p">},</span>
    <span class="s2">&quot;weather_agent&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a weather assistant&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">get_current_weather</span><span class="p">,</span> <span class="n">get_current_city</span><span class="p">],</span>
        <span class="s2">&quot;handoffs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;default_agent&quot;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="s2">&quot;code_agent&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="n">load_chat_model</span><span class="p">(</span><span class="s2">&quot;vllm:qwen3-coder-flash&quot;</span><span class="p">),</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;You are a coding assistant&quot;</span><span class="p">,</span>
        <span class="s2">&quot;tools&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">run_code</span><span class="p">,</span>
        <span class="p">],</span>
        <span class="s2">&quot;handoffs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;default_agent&quot;</span><span class="p">],</span>
    <span class="p">},</span>
    <span class="s2">&quot;default_agent&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="s2">&quot;You are an assistant&quot;</span><span class="p">,</span>
        <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="c1"># Set as the default agent</span>
        <span class="s2">&quot;handoffs&quot;</span><span class="p">:</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span>  <span class="c1"># This agent can hand off to all other agents</span>
    <span class="p">},</span>
<span class="p">}</span>
</code></pre></div>
<p>Finally, simply pass this configuration to <code>HandoffAgentMiddleware</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">HandoffAgentMiddleware</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span>
        <span class="n">get_current_time</span><span class="p">,</span>
        <span class="n">get_current_weather</span><span class="p">,</span>
        <span class="n">get_current_city</span><span class="p">,</span>
        <span class="n">run_code</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span><span class="n">HandoffAgentMiddleware</span><span class="p">(</span><span class="n">agents_config</span><span class="o">=</span><span class="n">agent_config</span><span class="p">)],</span>
<span class="p">)</span>

<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;What is the current time?&quot;</span><span class="p">)]})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>
<p>If you want to customize the description of the handoff tools, you can pass the second parameter <code>custom_handoffs_tool_descriptions</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">HandoffAgentMiddleware</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span>
        <span class="n">get_current_time</span><span class="p">,</span>
        <span class="n">get_current_weather</span><span class="p">,</span>
        <span class="n">get_current_city</span><span class="p">,</span>
        <span class="n">run_code</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span>
        <span class="n">HandoffAgentMiddleware</span><span class="p">(</span>
            <span class="n">agents_config</span><span class="o">=</span><span class="n">agent_config</span><span class="p">,</span>
            <span class="n">custom_handoffs_tool_descriptions</span><span class="o">=</span><span class="p">{</span>
                <span class="s2">&quot;time_agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Use this tool to hand off to the time assistant to resolve time query issues&quot;</span><span class="p">,</span>
                <span class="s2">&quot;weather_agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Use this tool to hand off to the weather assistant to resolve weather query issues&quot;</span><span class="p">,</span>
                <span class="s2">&quot;code_agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Use this tool to hand off to the code assistant to resolve coding issues&quot;</span><span class="p">,</span>
                <span class="s2">&quot;default_agent&quot;</span><span class="p">:</span> <span class="s2">&quot;Use this tool to hand off to the default assistant&quot;</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
<p>If you want to completely customize the logic of the handoff tool implementation, you can pass the third parameter <code>handoffs_tool_overrides</code>. Similar to the second parameter, it is also a dictionary where the key is the agent name and the value is the corresponding handoff tool implementation.</p>
<p>For example:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware.handoffs</span><span class="w"> </span><span class="kn">import</span> <span class="n">HandoffTool</span>

<span class="nd">@tool</span>
<span class="k">def</span><span class="w"> </span><span class="nf">transfer_to_code_agent</span><span class="p">(</span><span class="n">runtime</span><span class="p">:</span> <span class="n">ToolRuntime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Command</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This tool help you transfer to the code agent.&quot;&quot;&quot;</span>
    <span class="c1">#You can add custom logic here</span>
    <span class="k">return</span> <span class="n">Command</span><span class="p">(</span>
        <span class="n">update</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">ToolMessage</span><span class="p">(</span>
                    <span class="n">content</span><span class="o">=</span><span class="s2">&quot;transfer to code agent&quot;</span><span class="p">,</span>
                    <span class="n">tool_call_id</span><span class="o">=</span><span class="n">runtime</span><span class="o">.</span><span class="n">tool_call_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">],</span>
            <span class="s2">&quot;active_agent&quot;</span><span class="p">:</span> <span class="s2">&quot;code_agent&quot;</span><span class="p">,</span>
            <span class="c1">#You can add other keys to update here</span>
        <span class="p">}</span>
    <span class="p">)</span>

<span class="n">handoffs_tool_overrides</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;code_agent&quot;</span><span class="p">:</span> <span class="n">transfer_to_code_agent</span><span class="p">,</span>
<span class="p">}</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">HandoffAgentMiddleware</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span>
        <span class="n">get_current_time</span><span class="p">,</span>
        <span class="n">get_current_weather</span><span class="p">,</span>
        <span class="n">get_current_city</span><span class="p">,</span>
        <span class="n">run_code</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span>
        <span class="n">HandoffAgentMiddleware</span><span class="p">(</span>
            <span class="n">agents_config</span><span class="o">=</span><span class="n">agent_config</span><span class="p">,</span>
            <span class="n">handoffs_tool_overrides</span><span class="o">=</span><span class="n">handoffs_tool_overrides</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
<h2 id="tool-call-repair">Tool Call Repair</h2>
<p><code>ToolCallRepairMiddleware</code> is a middleware for <strong>automatically fixing invalid tool calls (<code>invalid_tool_calls</code>) from large models</strong>.</p>
<p>When large models output the JSON Schema for tool calls, they may generate JSON format errors due to the model's own reasons (errors are common in the <code>arguments</code> field), leading to JSON parsing failures. Such calls are stored in the <code>invalid_tool_calls</code> field. <code>ToolCallRepairMiddleware</code> will automatically detect <code>invalid_tool_calls</code> after the model returns results and attempt to fix them by calling <code>json-repair</code>, allowing the tool calls to execute normally.</p>
<p>Please ensure you have installed <code>langchain-dev-utils[standard]</code>, see the <strong>Installation Guide</strong> for details.</p>
<h3 id="parameter-description_3">Parameter Description</h3>
<p>This middleware is zero-configuration and ready to use out of the box, no additional parameters required.</p>
<h3 id="usage-example_2">Usage Example</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">ToolCallRepairMiddleware</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
    <span class="n">tools</span><span class="o">=</span><span class="p">[</span><span class="n">run_python_code</span><span class="p">,</span> <span class="n">get_current_time</span><span class="p">],</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span>
        <span class="n">ToolCallRepairMiddleware</span><span class="p">()</span>
    <span class="p">],</span>
<span class="p">)</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Note</p>
<p>This middleware cannot guarantee 100% fixing of all invalid tool calls; the actual effect depends on the repair capability of <code>json-repair</code>. Additionally, it only acts on invalid tool call content in the <code>invalid_tool_calls</code> field.</p>
</div>
<h2 id="formatting-system-prompts">Formatting System Prompts</h2>
<p><code>format_prompt</code> is a <strong>middleware instance</strong> that allows you to use <code>f-string</code> style placeholders (like <code>{name}</code>) in <code>system_prompt</code> and dynamically replace them with actual values at runtime.</p>
<h3 id="parameter-description_4">Parameter Description</h3>
<p>The values of variables in placeholders follow a clear resolution order:</p>
<ol>
<li><strong>First look up in <code>state</code></strong>: It first looks for fields with the same name as the placeholder in the <code>state</code> dictionary</li>
<li><strong>Then look up in <code>context</code></strong>: If the field is not found in <code>state</code>, it continues to look in the <code>context</code> object</li>
</ol>
<p>This order means that values in <code>state</code> have higher priority and can override values with the same name in <code>context</code>.</p>
<h3 id="usage-example_3">Usage Example</h3>
<h4 id="getting-variables-only-from-state">Getting Variables Only from <code>state</code></h4>
<p>This is the most basic usage, where all placeholder variables are provided by <code>state</code>.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">format_prompt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain.agents</span><span class="w"> </span><span class="kn">import</span> <span class="n">AgentState</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AssistantState</span><span class="p">(</span><span class="n">AgentState</span><span class="p">):</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="o">=</span><span class="s2">&quot;You are an intelligent assistant, your name is </span><span class="si">{name}</span><span class="s2">.&quot;</span><span class="p">,</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span><span class="n">format_prompt</span><span class="p">],</span>
    <span class="n">state_schema</span><span class="o">=</span><span class="n">AssistantState</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># When calling, you must provide a value for &#39;name&#39; in state</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="p">{</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;Hello&quot;</span><span class="p">)],</span> <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">}</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>
<h4 id="getting-variables-from-both-state-and-context">Getting Variables from Both <code>state</code> and <code>context</code></h4>
<p>Using both <code>state</code> and <code>context</code> simultaneously:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Context</span><span class="p">:</span>
    <span class="n">user</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
    <span class="c1"># {name} will be obtained from state, {user} will be obtained from context</span>
    <span class="n">system_prompt</span><span class="o">=</span><span class="s2">&quot;You are an intelligent assistant, your name is </span><span class="si">{name}</span><span class="s2">. Your user is named </span><span class="si">{user}</span><span class="s2">.&quot;</span><span class="p">,</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span><span class="n">format_prompt</span><span class="p">],</span>
    <span class="n">state_schema</span><span class="o">=</span><span class="n">AssistantState</span><span class="p">,</span>
    <span class="n">context_schema</span><span class="o">=</span><span class="n">Context</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># When calling, provide &#39;name&#39; for state and &#39;user&#39; for context</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;I want to visit New York for a few days, help me plan my itinerary&quot;</span><span class="p">)],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">context</span><span class="o">=</span><span class="n">Context</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s2">&quot;Zhang San&quot;</span><span class="p">),</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>
<h4 id="variable-override-example">Variable Override Example</h4>
<p>This example shows that when <code>state</code> and <code>context</code> have variables with the same name, the value in <code>state</code> takes precedence.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Context</span><span class="p">:</span>
    <span class="c1"># &#39;name&#39; is defined in context</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">user</span><span class="p">:</span> <span class="nb">str</span>

<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
    <span class="n">system_prompt</span><span class="o">=</span><span class="s2">&quot;You are an intelligent assistant, your name is </span><span class="si">{name}</span><span class="s2">. Your user is named </span><span class="si">{user}</span><span class="s2">.&quot;</span><span class="p">,</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span><span class="n">format_prompt</span><span class="p">],</span>
    <span class="n">state_schema</span><span class="o">=</span><span class="n">AssistantState</span><span class="p">,</span> <span class="c1"># &#39;name&#39; is also defined in state</span>
    <span class="n">context_schema</span><span class="o">=</span><span class="n">Context</span><span class="p">,</span>
<span class="p">)</span>

<span class="c1"># When calling, both state and context provide a value for &#39;name&#39;</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;What is your name?&quot;</span><span class="p">)],</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;assistant-1&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="n">context</span><span class="o">=</span><span class="n">Context</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;assistant-2&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s2">&quot;Zhang San&quot;</span><span class="p">),</span>
<span class="p">)</span>

<span class="c1"># The final system prompt will be &quot;You are an intelligent assistant, your name is assistant-1. Your user is named Zhang San.&quot;</span>
<span class="c1"># Because state has higher priority</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div>
<div class="admonition warning">
<p class="admonition-title">Note</p>
<p>There are two ways to implement custom middleware: decorators or class inheritance.<br />
- Class inheritance implementation: <code>PlanMiddleware</code>, <code>ModelMiddleware</code>, <code>HandoffAgentMiddleware</code>, <code>ToolCallRepairMiddleware</code><br />
- Decorator implementation: <code>format_prompt</code> (the decorator directly turns the function into a middleware instance, so no manual instantiation is needed to use it)</p>
</div>
<div class="admonition info">
<p class="admonition-title">Official Middleware Extensions</p>
<p>This library extends the following official middleware, supporting model specification through string parameters for models registered with <code>register_model_provider</code>:</p>
<p>You only need to import these middleware from this library to use string parameters for models registered with <code>register_model_provider</code>. The usage of the middleware remains consistent with the official middleware, for example:
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">langchain_core.messages</span><span class="w"> </span><span class="kn">import</span> <span class="n">AIMessage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.agents.middleware</span><span class="w"> </span><span class="kn">import</span> <span class="n">SummarizationMiddleware</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">langchain_dev_utils.chat_models</span><span class="w"> </span><span class="kn">import</span> <span class="n">register_model_provider</span>

<span class="n">register_model_provider</span><span class="p">(</span>
    <span class="n">provider_name</span><span class="o">=</span><span class="s2">&quot;vllm&quot;</span><span class="p">,</span>
    <span class="n">chat_model</span><span class="o">=</span><span class="s2">&quot;openai-compatible&quot;</span><span class="p">,</span>
    <span class="n">base_url</span><span class="o">=</span><span class="s2">&quot;http://localhost:8000/v1&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">create_agent</span><span class="p">(</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
    <span class="n">middleware</span><span class="o">=</span><span class="p">[</span>
        <span class="n">SummarizationMiddleware</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="s2">&quot;vllm:qwen3-4b&quot;</span><span class="p">,</span>
            <span class="n">trigger</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;tokens&quot;</span><span class="p">,</span> <span class="mi">50</span><span class="p">),</span>
            <span class="n">keep</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
        <span class="p">)</span>
    <span class="p">],</span>
    <span class="n">system_prompt</span><span class="o">=</span><span class="s2">&quot;You are an intelligent AI assistant that can solve user problems&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># big_text is a text containing a lot of content, omitted here</span>
<span class="n">big_messages</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;Hello, who are you&quot;</span><span class="p">),</span>
    <span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;I am your AI assistant&quot;</span><span class="p">),</span>
    <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;Write a beautiful long text&quot;</span><span class="p">),</span>
    <span class="n">AIMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Okay, I will write a beautiful long text, the content is: </span><span class="si">{</span><span class="n">big_text</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
    <span class="n">HumanMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;Why did you write this long text?&quot;</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">invoke</span><span class="p">({</span><span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="n">big_messages</span><span class="p">})</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</code></pre></div></p>
</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.instant", "navigation.tracking", "navigation.top", "search.suggest", "search.highlight", "search.share", "content.code.copy", "content.code.annotate", "content.tabs.link", "content.tooltips", "content.footnote.tooltips"], "search": "../../assets/javascripts/workers/search.7a47a382.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.e71a0d61.min.js"></script>
      
    
  </body>
</html>